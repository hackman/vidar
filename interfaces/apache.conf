# a2enmod proxy proxy_http headers
# ======================================================================
# User-Agent Log Perl API via reverse proxy to Starman on 127.0.0.1:5000
# ======================================================================


# If this API lives under an existing site, you can move the <Location /api/>
# block into that vhost. Below is a standalone virtual host example:

<VirtualHost *:80>
    ServerName api.example.test   # change to your hostname
    # If youâ€™re serving only API JSON, no DocumentRoot is necessary.
    # But Apache wants one; set a minimal one:
    DocumentRoot /var/www/empty
    <Directory /var/www/empty>
        Require all granted
    </Directory>

    # Useful headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "no-referrer-when-downgrade"

    # Optional: H2 if you have mod_http2 loaded (and TLS vhost)
    # Protocols h2 http/1.1

    # --- API proxy ---
    # Keep path the same: /api/* -> http://127.0.0.1:5000/api/*
    ProxyPreserveHost On
    ProxyRequests Off

    # Tight timeouts (adjust if queries may be expensive)
    ProxyTimeout 10

    # Connection pooling/keepalive to backend
    <Proxy "http://api_upstream">
        # Using a named balancer eases future scale-out
        BalancerMember "http://127.0.0.1:5000" keepalive=On
        ProxySet lbmethod=byrequests
    </Proxy>

    # CORS (optional; keep if UI is on a different origin)
    SetEnvIf Origin ".*" ORIGIN=$0
    Header always set Access-Control-Allow-Origin "%{ORIGIN}e" env=ORIGIN
    Header always set Access-Control-Allow-Headers "Content-Type"
    Header always set Access-Control-Allow-Methods "GET,OPTIONS"
    # Preflight short-circuit
    <Location "/api/">
        <If "%{REQUEST_METHOD} == 'OPTIONS'">
            Require all granted
        </If>
    </Location>

    # Map /api/ to backend
    ProxyPass        /api/  http://api_upstream/api/ connectiontimeout=2 timeout=10
    ProxyPassReverse /api/  http://api_upstream/api/

    # Forwarded headers
    RequestHeader set X-Forwarded-Proto expr=%{REQUEST_SCHEME}
    RequestHeader set X-Forwarded-For   expr=%{REMOTE_ADDR}

    # Logs
    ErrorLog  logs/ualog-api_error.log
    CustomLog logs/ualog-api_access.log combined
</VirtualHost>


